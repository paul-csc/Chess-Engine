#ifndef BITBOARD_H
#define BITBOARD_H

#include "types.h"

namespace ChessCpp {
class Magics {
  private:
    static constexpr int RookShifts[SQUARE_NB] = {
        52, 52, 52, 52, 52, 52, 52, 52, 53, 53, 53, 54, 53, 53, 54, 53, 53, 54, 54, 54, 53, 53,
        54, 53, 53, 54, 53, 53, 54, 54, 54, 53, 52, 54, 53, 53, 53, 53, 54, 53, 52, 53, 54, 54,
        53, 53, 54, 53, 53, 54, 54, 54, 53, 53, 54, 53, 52, 53, 53, 53, 53, 53, 53, 52};

    static constexpr int BishopShifts[SQUARE_NB] = {
        58, 60, 59, 59, 59, 59, 60, 58, 60, 59, 59, 59, 59, 59, 59, 60, 59, 59, 57, 57, 57, 57,
        59, 59, 59, 59, 57, 55, 55, 57, 59, 59, 59, 59, 57, 55, 55, 57, 59, 59, 59, 59, 57, 57,
        57, 57, 59, 59, 60, 60, 59, 59, 59, 59, 60, 60, 58, 60, 59, 59, 59, 59, 59, 58};

    static constexpr Bitboard RookMagics[SQUARE_NB] = {
        0X68000814008B4A0ULL,  0XFFBFFFDFF7EFDFFDULL, 0X232000AC16A02028ULL, 0X5490000442001110ULL,
        0XBFEFFE7BFCF5F9F7ULL, 0XDFE7DFF7FAFFFF7BULL, 0XAFEFEFF77FBDFFF9ULL, 0X4B00017282420100ULL,
        0X780084002A984ULL,    0XFFBFF7DFBF6FE3BEULL, 0XEFFFAFFEEF9FFDFFULL, 0X448A002040B2002AULL,
        0X6AD97FD7FBFF7FDEULL, 0X7DFDFFFDFEF7EFFFULL, 0X806000200010C68ULL,  0X83CA800080014300ULL,
        0X1008208000400199ULL, 0X8002808020044004ULL, 0X197A020040322180ULL, 0X710C2000A001122ULL,
        0XE6D7FDFFDFFBF5FFULL, 0XFFFFBFEEFDFC7FFFULL, 0X858E34006A100F08ULL, 0X4083A20002841043ULL,
        0XA4000C480008365ULL,  0X180CA08100400508ULL, 0X2150717010040800ULL, 0X48001000A0040A18ULL,
        0X908801190011001CULL, 0X10220082005C0810ULL, 0X8268502400281302ULL, 0X8A341820010490CULL,
        0X6EFFDFF7AFBFFF3EULL, 0X6B21A010084000C3ULL, 0XE090000880C5E000ULL, 0XFFEEFFAFFCFFFBDFULL,
        0X4807830010040ULL,    0XFFFFEFFBF7FF5FBFULL, 0X10D91210D4000308ULL, 0X4088938502000444ULL,
        0X860184A040544000ULL, 0XFFF7BFF77DF677FFULL, 0X33486280B2020041ULL, 0X9310210470010018ULL,
        0XFFD9FEFB23B1FFFEULL, 0XFFFFEFFDFFFB7FDFULL, 0X3000C21D08040010ULL, 0X8B00058C410016ULL,
        0X800E8002A9400680ULL, 0X59E2C4AE01008200ULL, 0X11A110A0C2048200ULL, 0X280083B000680080ULL,
        0XA04008A014265001ULL, 0X19C4088200010040ULL, 0X925082A303C00ULL,    0X448221840AC90600ULL,
        0XBDFFFEFBBDDD7FFFULL, 0XDBFFFF3FEFD7BFFFULL, 0XFDFFFFDFFFBFAFB5ULL, 0XAFFFFEFF9FEFFF57ULL,
        0XBFEFFFFDF7FA9D6EULL, 0XFDFFFFE7FBFFFEFFULL, 0X6DF7FFF7FEFDEFFCULL, 0X41B3988401214702ULL};

    static constexpr Bitboard BishopMagics[SQUARE_NB] = {
        0XE51EBB94FBE45BFFULL, 0XC7B9F567ED8FFE7FULL, 0X19A8282157800224ULL, 0X4D41401923C73BEULL,
        0X480404A14244000DULL, 0X340E01FEA0C933AFULL, 0XFFC3F989D57FE9ECULL, 0XF7FF3FDD6EFBFFFFULL,
        0XE7F974F4F9D9F7F5ULL, 0X222161180311C580ULL, 0X62003808704081A0ULL, 0X70425C0408830360ULL,
        0X66E5E110419250CDULL, 0X8420220834154952ULL, 0XEDE7F5ADF8FDFFFDULL, 0X7F7EEA5F3D59BF5EULL,
        0X4478024050810631ULL, 0X2A22030490025601ULL, 0XD0E4044848002500ULL, 0X518C08C801212289ULL,
        0X1002004402111108ULL, 0X5858102901009007ULL, 0X2230A1C412051005ULL, 0X142B042E41082700ULL,
        0X882011AE8850A508ULL, 0X274320C508181108ULL, 0X80090048E040014ULL,  0X508C00C01C0100B2ULL,
        0X424300102B004000ULL, 0X490144022080230ULL,  0X20C280B11C020814ULL, 0X20600C42C9212ULL,
        0XF3BFC5C66B10122FULL, 0XA25801B000C42434ULL, 0X500144A208900400ULL, 0X6080140400780120ULL,
        0X124C0B40100C0100ULL, 0X7048004100909018ULL, 0XE8781EC402008A01ULL, 0X4D221A0600807284ULL,
        0XED4FF5C4EA9B2418ULL, 0X6D9FE6F7B7EFDEB4ULL, 0X433D610048044041ULL, 0X86A2018040300ULL,
        0X214B14110C006200ULL, 0X60D2241106001C0AULL, 0X2B7F1018F2EBFDCCULL, 0X783438008E252100ULL,
        0XEFBFFD71EEAD7FFFULL, 0XD597FE7D435F79FFULL, 0X9FFFF7FB3D9C7377ULL, 0X8910144620981000ULL,
        0XE40D01A0208A40F9ULL, 0XA63240B31425025CULL, 0X9EFFEBF61DD769FBULL, 0X877FCE36D752FA8EULL,
        0XEB5FFD776D5FDFBEULL, 0XD7FDFFFEBCF2DEFFULL, 0XD01801C04208900FULL, 0X830639EF5720980AULL,
        0XC9C018202182C400ULL, 0X893B2D4094880E8CULL, 0XFBBEFDF552EB5AE6ULL, 0XFEFFFBFB7BDFDDFBULL};

    static constexpr Bitboard RookMasks[SQUARE_NB] = {
        0X101010101017eULL,    0X202020202027cULL,    0X404040404047aULL,    0X8080808080876ULL,
        0X1010101010106eULL,   0X2020202020205eULL,   0X4040404040403eULL,   0X8080808080807eULL,
        0X1010101017e00ULL,    0X2020202027c00ULL,    0X4040404047a00ULL,    0X8080808087600ULL,
        0X10101010106e00ULL,   0X20202020205e00ULL,   0X40404040403e00ULL,   0X80808080807e00ULL,
        0X10101017e0100ULL,    0X20202027c0200ULL,    0X40404047a0400ULL,    0X8080808760800ULL,
        0X101010106e1000ULL,   0X202020205e2000ULL,   0X404040403e4000ULL,   0X808080807e8000ULL,
        0X101017e010100ULL,    0X202027c020200ULL,    0X404047a040400ULL,    0X8080876080800ULL,
        0X1010106e101000ULL,   0X2020205e202000ULL,   0X4040403e404000ULL,   0X8080807e808000ULL,
        0X1017e01010100ULL,    0X2027c02020200ULL,    0X4047a04040400ULL,    0X8087608080800ULL,
        0X10106e10101000ULL,   0X20205e20202000ULL,   0X40403e40404000ULL,   0X80807e80808000ULL,
        0X17e0101010100ULL,    0X27c0202020200ULL,    0X47a0404040400ULL,    0X8760808080800ULL,
        0X106e1010101000ULL,   0X205e2020202000ULL,   0X403e4040404000ULL,   0X807e8080808000ULL,
        0X7e010101010100ULL,   0X7c020202020200ULL,   0X7a040404040400ULL,   0X76080808080800ULL,
        0X6e101010101000ULL,   0X5e202020202000ULL,   0X3e404040404000ULL,   0X7e808080808000ULL,
        0X7e01010101010100ULL, 0X7c02020202020200ULL, 0X7a04040404040400ULL, 0X7608080808080800ULL,
        0X6e10101010101000ULL, 0X5e20202020202000ULL, 0X3e40404040404000ULL, 0X7e80808080808000ULL};

    static constexpr Bitboard BishopMasks[SQUARE_NB] = {
        0X40201008040200ULL, 0X402010080400ULL,   0X4020100A00ULL,     0X40221400ULL,
        0X2442800ULL,        0X204085000ULL,      0X20408102000ULL,    0X2040810204000ULL,
        0X20100804020000ULL, 0X40201008040000ULL, 0X4020100A0000ULL,   0X4022140000ULL,
        0X244280000ULL,      0X20408500000ULL,    0X2040810200000ULL,  0X4081020400000ULL,
        0X10080402000200ULL, 0X20100804000400ULL, 0X4020100A000A00ULL, 0X402214001400ULL,
        0X24428002800ULL,    0X2040850005000ULL,  0X4081020002000ULL,  0X8102040004000ULL,
        0X8040200020400ULL,  0X10080400040800ULL, 0X20100A000A1000ULL, 0X40221400142200ULL,
        0X2442800284400ULL,  0X4085000500800ULL,  0X8102000201000ULL,  0X10204000402000ULL,
        0X4020002040800ULL,  0X8040004081000ULL,  0X100A000A102000ULL, 0X22140014224000ULL,
        0X44280028440200ULL, 0X8500050080400ULL,  0X10200020100800ULL, 0X20400040201000ULL,
        0X2000204081000ULL,  0X4000408102000ULL,  0XA000A10204000ULL,  0X14001422400000ULL,
        0X28002844020000ULL, 0X50005008040200ULL, 0X20002010080400ULL, 0X40004020100800ULL,
        0X20408102000ULL,    0X40810204000ULL,    0XA1020400000ULL,    0X142240000000ULL,
        0X284402000000ULL,   0X500804020000ULL,   0X201008040200ULL,   0X402010080400ULL,
        0X2040810204000ULL,  0X4081020400000ULL,  0XA102040000000ULL,  0X14224000000000ULL,
        0X28440200000000ULL, 0X50080402000000ULL, 0X20100804020000ULL, 0X40201008040200};

    inline static Bitboard RookAttackTable[SQUARE_NB][4096] = {};
    inline static Bitboard BishopAttackTable[SQUARE_NB][1024] = {};

    static constexpr void
    createAllBlockerBitboards(Bitboard movementMask, Bitboard blockers[], int& numPatterns);

    constexpr static Bitboard createRookLegalMovesBitboard(Square square, Bitboard blockBitboard);

    constexpr static Bitboard createBishopLegalMovesBitboard(Square square, Bitboard blockBitboard);

  public:
    Magics() = delete;
    static void init();

    inline static Bitboard getRookAttacks(Square square, Bitboard occupancy) {
        return RookAttackTable[square][((occupancy & RookMasks[square]) * RookMagics[square])
                                       >> RookShifts[square]];
    }

    inline static Bitboard getBishopAttacks(Square square, Bitboard occupancy) {
        return BishopAttackTable[square][((occupancy & BishopMasks[square]) * BishopMagics[square])
                                         >> BishopShifts[square]];
    }
};

namespace Precomputed {
constexpr Bitboard KnightAttacks[64] = {
    0X20400ULL, 0X50800ULL, 0XA1100ULL, 0X142200ULL, 0X284400ULL, 0X508800ULL, 0XA01000ULL, 0X402000ULL, 0X2040004ULL, 0X5080008ULL, 0XA110011ULL, 0X14220022ULL, 0X28440044ULL, 0X50880088ULL, 0XA0100010ULL, 0X40200020ULL, 0X204000402ULL, 0X508000805ULL, 0XA1100110AULL, 0X1422002214ULL, 0X2844004428ULL, 0X5088008850ULL, 0XA0100010A0ULL, 0X4020002040ULL, 0X20400040200ULL, 0X50800080500ULL, 0XA1100110A00ULL, 0X142200221400ULL, 0X284400442800ULL, 0X508800885000ULL, 0XA0100010A000ULL, 0X402000204000ULL, 0X2040004020000ULL, 0X5080008050000ULL, 0XA1100110A0000ULL, 0X14220022140000ULL, 0X28440044280000ULL, 0X50880088500000ULL, 0XA0100010A00000ULL, 0X40200020400000ULL, 0X204000402000000ULL, 0X508000805000000ULL, 0XA1100110A000000ULL, 0X1422002214000000ULL, 0X2844004428000000ULL, 0X5088008850000000ULL, 0XA0100010A0000000ULL, 0X4020002040000000ULL, 0X400040200000000ULL, 0X800080500000000ULL, 0X1100110A00000000ULL, 0X2200221400000000ULL, 0X4400442800000000ULL, 0X8800885000000000ULL, 0X100010A000000000ULL, 0X2000204000000000ULL, 0X4020000000000ULL, 0X8050000000000ULL, 0X110A0000000000ULL, 0X22140000000000ULL, 0X44280000000000ULL, 0X88500000000000ULL, 0X10A00000000000ULL, 0X20400000000000ULL
};

constexpr Bitboard KingAttacks[64] = {
    0X302ULL,0X705ULL,0XE0AULL,0X1C14ULL,0X3828ULL,0X7050ULL,0XE0A0ULL,0XC040ULL,0X30203ULL,0X70507ULL,0XE0A0EULL,0X1C141CULL,0X382838ULL,0X705070ULL,0XE0A0E0ULL,0XC040C0ULL,0X3020300ULL,0X7050700ULL,0XE0A0E00ULL,0X1C141C00ULL,0X38283800ULL,0X70507000ULL,0XE0A0E000ULL,0XC040C000ULL,0X302030000ULL,0X705070000ULL,0XE0A0E0000ULL,0X1C141C0000ULL,0X3828380000ULL,0X7050700000ULL,0XE0A0E00000ULL,0XC040C00000ULL,0X30203000000ULL,0X70507000000ULL,0XE0A0E000000ULL,0X1C141C000000ULL,0X382838000000ULL,0X705070000000ULL,0XE0A0E0000000ULL,0XC040C0000000ULL,0X3020300000000ULL,0X7050700000000ULL,0XE0A0E00000000ULL,0X1C141C00000000ULL,0X38283800000000ULL,0X70507000000000ULL,0XE0A0E000000000ULL,0XC040C000000000ULL,0X302030000000000ULL,0X705070000000000ULL,0XE0A0E0000000000ULL,0X1C141C0000000000ULL, 0X3828380000000000ULL, 0X7050700000000000ULL, 0XE0A0E00000000000ULL, 0XC040C00000000000ULL, 0X203000000000000ULL,0X507000000000000ULL,0XA0E000000000000ULL,0X141C000000000000ULL, 0X2838000000000000ULL, 0X5070000000000000ULL, 0XA0E0000000000000ULL, 0X40C0000000000000ULL
};

constexpr Bitboard PawnAttacks[2][64] = {
    { // White
        0ULL, 0ULL, 0ULL, 0ULL, 0ULL, 0ULL, 0ULL, 0ULL, 0X20000ULL, 0X50000ULL, 0XA0000ULL, 0X140000ULL, 0X280000ULL, 0X500000ULL, 0XA00000ULL, 0X400000ULL, 0X2000000ULL, 0X5000000ULL, 0XA000000ULL, 0X14000000ULL, 0X28000000ULL, 0X50000000ULL, 0XA0000000ULL, 0X40000000ULL, 0X200000000ULL, 0X500000000ULL, 0XA00000000ULL, 0X1400000000ULL, 0X2800000000ULL, 0X5000000000ULL, 0XA000000000ULL, 0X4000000000ULL, 0X20000000000ULL, 0X50000000000ULL, 0XA0000000000ULL, 0X140000000000ULL, 0X280000000000ULL, 0X500000000000ULL, 0XA00000000000ULL, 0X400000000000ULL, 0X2000000000000ULL, 0X5000000000000ULL, 0XA000000000000ULL, 0X14000000000000ULL, 0X28000000000000ULL, 0X50000000000000ULL, 0XA0000000000000ULL, 0X40000000000000ULL, 0X200000000000000ULL, 0X500000000000000ULL, 0XA00000000000000ULL, 0X1400000000000000ULL, 0X2800000000000000ULL, 0X5000000000000000ULL, 0XA000000000000000ULL, 0X4000000000000000ULL, 0ULL, 0ULL, 0ULL, 0ULL, 0ULL, 0ULL, 0ULL, 0ULL
    }, { // Black
        0ULL, 0ULL, 0ULL, 0ULL, 0ULL, 0ULL, 0ULL, 0ULL, 0X2ULL, 0X5ULL, 0XAULL, 0X14ULL, 0X28ULL, 0X50ULL, 0XA0ULL, 0X40ULL, 0X200ULL, 0X500ULL, 0XA00ULL, 0X1400ULL, 0X2800ULL, 0X5000ULL, 0XA000ULL, 0X4000ULL, 0X20000ULL, 0X50000ULL, 0XA0000ULL, 0X140000ULL, 0X280000ULL, 0X500000ULL, 0XA00000ULL, 0X400000ULL, 0X2000000ULL, 0X5000000ULL, 0XA000000ULL, 0X14000000ULL, 0X28000000ULL, 0X50000000ULL, 0XA0000000ULL, 0X40000000ULL, 0X200000000ULL, 0X500000000ULL, 0XA00000000ULL, 0X1400000000ULL, 0X2800000000ULL, 0X5000000000ULL, 0XA000000000ULL, 0X4000000000ULL, 0X20000000000ULL, 0X50000000000ULL, 0XA0000000000ULL, 0X140000000000ULL, 0X280000000000ULL, 0X500000000000ULL, 0XA00000000000ULL, 0X400000000000ULL, 0ULL, 0ULL, 0ULL, 0ULL, 0ULL, 0ULL, 0ULL, 0ULL
    }
};
}

constexpr Bitboard square_bb(Square s) {
    ASSERT(is_ok(s));
    return (1ULL << s);
}

inline Square pop_lsb(Bitboard& b) {
    ASSERT(b);
    Square index = Square(__builtin_ctzll(b));
    b &= (b - 1);
    return index;
}

inline Square pop_count(Bitboard b) { return Square(__builtin_popcountll(b)); }

inline void set_bit(Bitboard& b, Square sq) { b |= (1ULL << sq); }

inline void clear_bit(Bitboard& b, Square sq) { b &= ~(1ULL << sq); }
}

#endif  // BITBOARD_H
